Parameters:
  Repo:
    Type: String
    Description: The name of the repo
  Branch:
    Type: String
    Description: The name of the branch in the repo
  OAuth:
    Type: String
    Description: The OAuth token to use for the repo
  ServiceName:
    Type: String
    Description: The Service name
  TemplateLoc:
    Type: String
    Description: The bucket url where these templates are stored

Resources:
  BucketsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub ${TemplateLoc}/buckets.yml
      Parameters:
        ServiceName: !Ref ServiceName

  RolesStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: BucketsStack
    Properties:
      TemplateURL: !Sub ${TemplateLoc}/roles.yml
      Parameters:
        ServiceName: !Ref ServiceName
        OutBucket: !GetAtt BucketsStack.Outputs.OutBucket
        ArtifactBucket: !GetAtt BucketsStack.Outputs.ArtifactBucket

  ResourcesStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: RolesStack
    Properties:
      TemplateURL: !Sub ${TemplateLoc}/resources.yml
      Parameters:
        OutBucket: !GetAtt BucketsStack.Outputs.OutBucket
        ArtifactBucket: !GetAtt BucketsStack.Outputs.ArtifactBucket
        RoleArn: !GetAtt RolesStack.Outputs.RoleArn
        ServiceName: !Ref ServiceName
        Repo: !Ref Repo
        Branch: !Ref Branch
        OAuth: !Ref OAuth
